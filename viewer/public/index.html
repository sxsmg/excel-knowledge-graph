<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spreadsheet-Brain Viewer</title>
  <style>
    body { margin:0; font-family:system-ui }
    #toolbar {
      display:flex; gap:6px; align-items:center;
      padding:8px; background:#fafafa; border-bottom:1px solid #ddd;
    }
    #query { flex:1; padding:6px; font-size:14px }
    button { padding:6px 12px; font-size:14px; cursor:pointer }
    #status { margin-left:8px; color:#555; }
    #answer {
      position:absolute; top:56px; right:16px; max-width:320px;
      padding:8px; background:#fff; border:1px solid #ccc;
      border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,.12);
      display:none;
    }
    #viz { width:100%; height:calc(100vh - 50px) }
  </style>

  <script src="/neovis.js"></script>
  <script src="/vis-network.min.js"></script>
</head>

<body onload="init()">
  <div id="toolbar">
    <input id="query" placeholder="Enter question or update…" />
    <button onclick="sendRun()">Run</button>
    <button onclick="draw()">Reload</button>
    <span id="status"></span>
  </div>
  <div id="answer"></div>
  <div id="viz"></div>

<script>
const API = "http://localhost:8000";
let viz, cfg, meta;

async function init(){
  cfg  = await fetch("/config").then(r=>r.json());
  meta = await fetch(`${API}/labels`).then(r=>r.json());
  draw();
}

function draw(){
  const labelConfig = Object.fromEntries(
    meta.nodeLabels.map(l=>[l,{caption:"name"}])
  );
  const config = {
    containerId: "viz",
    neo4j:       { serverUrl:cfg.uri, serverUser:cfg.user, serverPassword:cfg.password },
    labels:      labelConfig,
    relationships:{},
    initialCypher:"MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 300"
  };
  if(!window.NeoVis?.default) return setStatus("❌ NeoVis missing");
  setStatus("Rendering…");
  viz = new NeoVis.default(config);
  viz.render();
  viz.registerOnEvent("completed",()=>setStatus("✅ ready"));
}

function setStatus(txt){
  document.getElementById("status").textContent = txt;
}

async function sendRun(){
  const inst = document.getElementById("query").value.trim();
  if(!inst) return;
  setStatus("⏳ running…");
  document.getElementById("answer").style.display="none";

  try {
    const res = await fetch(`${API}/run`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ instruction: inst })
    }).then(r=>r.json());

    // if rows present → show them; if status → show that
    let text;
    if(res.rows){
      text = "Rows:\n" + res.rows.map(r=>r.join(", ")).join("\n");
    } else {
      text = res.status || "✅ write applied";
    }
    const ans = document.getElementById("answer");
    ans.textContent = text;
    ans.style.display = "block";

    // If it was a write, re‐draw
    if(!res.rows){
      draw();
    }
    setStatus("✅ done");
  } catch(e){
    setStatus("❌ " + e.message);
  }
}
</script>
</body>
</html>
